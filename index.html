<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sistema de Gerenciamento de Plant√£o - UTI (Modificado)</title>
    <style>
        :root{
            --primary:#233142;
            --secondary:#0ea5b7;
            --accent:#e74c3c;
            --success:#16a34a;
            --warning:#f59e0b;
            --muted:#6b7280;
            --bg:#f4f7fb;
            --card:#fff;
            --radius:10px;
            --shadow: 0 6px 18px rgba(35,49,66,0.08);
        }
        *{box-sizing:border-box;font-family:Inter, "Segoe UI", Roboto, Arial; }
        body{background:var(--bg);margin:0;color:#0f1724}
        .container{max-width:1200px;margin:20px auto;padding:16px}
        header{background:linear-gradient(90deg,var(--primary), #2c6b78); color:white;padding:14px;border-radius:10px;box-shadow:var(--shadow)}
        .header-inner{display:flex;justify-content:space-between;align-items:center}
        h1{font-size:1.15rem;margin:0}
        .date-today{opacity:0.9}
        .nav-tabs{display:flex;gap:8px;margin-top:14px}
        .tab{padding:10px 14px;border-radius:8px;background:rgba(255,255,255,0.06);color:#fff;cursor:pointer}
        .tab.active{background:white;color:var(--primary);box-shadow:var(--shadow)}
        .card{background:var(--card);border-radius:var(--radius);padding:16px;margin-top:16px;box-shadow:var(--shadow)}
        .card-header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
        .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
        .btn-primary{background:var(--secondary);color:white}
        .btn-secondary{background:#334155;color:white}
        .btn-success{background:var(--success);color:white}
        .btn-danger{background:var(--accent);color:white}
        .btn-ghost{background:transparent;border:1px solid #e6eef1;color:var(--muted)}
        .leitos-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;margin-top:12px}
        .leito-card{background:linear-gradient(180deg,#fff,#fbfeff);border-radius:12px;padding:14px;box-shadow:var(--shadow);position:relative;min-height:160px}
        .leito-num{font-weight:700;color:var(--primary);margin-bottom:6px}
        .leito-paciente{font-weight:700;margin-bottom:6px}
        .leito-dx{color:var(--muted);margin-bottom:8px}
        .leito-tags{display:flex;gap:8px;flex-wrap:wrap}
        .badge{padding:6px 8px;border-radius:8px;font-weight:700;font-size:0.8rem}
        .badge-iso{background:#ffe4e6;color:#b91c1c}
        .dispositivo{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#f8fafc;margin-top:8px}
        .dispositivo.vencido{background:#fff1f0;color:var(--accent);border:1px solid rgba(231,76,60,0.12)}
        .dispositivo.proximo{background:#fff7ed;color:var(--warning);border:1px solid rgba(245,158,11,0.12)}
        .modal{display:none;position:fixed;inset:0;background:rgba(2,6,23,0.45);align-items:center;justify-content:center;padding:20px;z-index:9999}
        .modal.open{display:flex}
        .modal-content{background:var(--card);width:100%;max-width:820px;border-radius:12px;padding:18px;box-shadow:var(--shadow);max-height:90vh;overflow:auto}
        .modal-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .form-group{margin-bottom:12px}
        label{display:block;font-weight:600;margin-bottom:6px;color:#0f1724}
        input[type="text"],input[type="date"],textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef1}
        .device-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:#fbfdff;border:1px solid #eef6f8;margin-bottom:8px}
        .device-item .left{display:flex;gap:8px;align-items:center}
        .device-list{max-height:300px;overflow:auto;padding-right:6px}
        .small{font-size:0.85rem;color:var(--muted)}
        table{width:100%;border-collapse:collapse}
        th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:center;font-size:0.95rem}
        thead th{background:#fbfbfd;text-align:left;color:var(--muted)}
        .status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle}
        .dot-danger{background:var(--accent)}
        .dot-warning{background:var(--warning)}
        .dot-success{background:var(--success)}
        .flex{display:flex;align-items:center;gap:8px}
        .right{text-align:right}
        .checklist-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
        .checklist-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;background:#fbfdff;border:1px solid #eef5f7}
        .checklist-item.checked{background:#ecfdf5;border-color:rgba(16,185,129,0.12)}
        .notice{font-size:0.9rem;color:var(--muted)}
        footer{text-align:center;margin-top:18px;color:var(--muted);font-size:0.9rem}
        .tab-content{display:none}
        .tab-content.active{display:block}
        /* responsive */
        @media (max-width:800px){ .modal-grid{grid-template-columns:1fr} .leitos-grid{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))} }
    </style>
</head>
<body>
    <header>
        <div class="container header-inner">
            <div style="display:flex;gap:12px;align-items:center">
                <div style="font-size:22px">üè•</div>
                <div>
                    <h1>Sistema de Gerenciamento - UTI</h1>
                    <div class="small">Controle r√°pido de plant√µes e dispositivos</div>
                </div>
            </div>
            <div class="date-today" id="current-date">--</div>
        </div>
    </header>

    <div class="container">
        <div class="nav-tabs" role="tablist">
            <div class="tab active" data-tab="leitos">Leitos e Pacientes</div>
            <div class="tab" data-tab="checklist-diario">Checklist Di√°rio</div>
            <div class="tab" data-tab="checklist-pacientes">Checklist por Paciente</div>
        </div>

        <!-- LEITOS -->
        <div id="leitos" class="tab-content active">
            <div class="card">
                <div class="card-header">
                    <div style="display:flex;flex-direction:column">
                        <div style="font-weight:800">Leitos da UTI</div>
                        <div class="small">Visualize pacientes, dispositivos e prazos</div>
                    </div>

                    <div style="display:flex;gap:8px;flex-wrap:wrap">
                        <button class="btn btn-info btn-primary" id="gerar-relatorio-btn">Gerar Round (Relat√≥rio)</button>
                        <button class="btn btn-ghost" id="gerenciar-dispositivos-globais-btn">Gerenciar Dispositivos Globais</button>
                        <button class="btn btn-primary" id="adicionar-paciente-btn">Adicionar Paciente</button>
                    </div>
                </div>

                <div class="leitos-grid" id="leitos-grid"></div>
            </div>

            <!-- Quadro Geral -->
            <div class="card">
                <div class="card-header">
                    <div style="font-weight:800">Quadro Geral de Dispositivos (Todos os Pacientes)</div>
                    <div class="small">As cores indicam status (vencido/pr√≥ximo/dentro)</div>
                </div>
                <div style="overflow:auto">
                    <table class="dispositivos-table">
                        <thead id="quadro-geral-header">
                            <tr>
                                <th>Leito</th>
                                <th>Paciente</th>
                                <th>Data Admiss√£o</th>
                                <!-- dispositivos din√¢micos ser√£o inseridos -->
                            </tr>
                        </thead>
                        <tbody id="quadro-geral-tbody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Dispositivos Pr√≥ximos/Vencidos -->
            <div class="card">
                <div class="card-header">
                    <div style="font-weight:800">Dispositivos Pr√≥ximos do Vencimento / Vencidos</div>
                </div>
                <div style="overflow:auto">
                    <table class="dispositivos-table">
                        <thead>
                            <tr>
                                <th>Leito</th>
                                <th>Paciente</th>
                                <th>Dispositivo</th>
                                <th>Data de Inser√ß√£o</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="dispositivos-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CHECKLIST DIARIO -->
        <div id="checklist-diario" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div style="font-weight:800">Checklist Di√°rio</div>
                    <div style="display:flex;gap:8px">
                        <button class="btn btn-success" id="salvar-checklist-diario">Salvar Checklist</button>
                        <div class="notice">Os itens "Pedido da Farm√°cia do dia seguinte" aparecer√£o somente √†s ter√ßas e quintas.</div>
                    </div>
                </div>

                <div style="margin-top:12px" class="checklist-grid" id="checklist-diario-content">
                    <div>
                        <h4>Verifica√ß√µes Gerais</h4>
                        <div class="checklist-item"><input type="checkbox" id="check-carrinho1"><label for="check-carrinho1">Check Carrinho 1</label></div>
                        <div class="checklist-item"><input type="checkbox" id="check-carrinho2"><label for="check-carrinho2">Check Carrinho 2</label></div>
                        <div class="checklist-item"><input type="checkbox" id="check-livro-ocorrencias"><label for="check-livro-ocorrencias">Abrir Livro de Ocorr√™ncias</label></div>
                        <div class="checklist-item"><input type="checkbox" id="check-psicotropicos"><label for="check-psicotropicos">Checar Psicotr√≥picos</label></div>
                    </div>

                    <div>
                        <h4>Verifica√ß√µes de Geladeira</h4>
                        <div class="checklist-item"><input type="checkbox" id="check-geladeira-8h"><label for="check-geladeira-8h">Checar Geladeira (8h)</label></div>
                        <div class="checklist-item"><input type="checkbox" id="check-geladeira-18h"><label for="check-geladeira-18h">Checar Geladeira (18h)</label></div>
                    </div>

                    <div id="farmacia-checklist-section">
                        <h4>Pedido da Farm√°cia</h4>
                        <div class="checklist-item" id="pedido-farmacia-item">
                            <input type="checkbox" id="check-pedido-farmacia">
                            <label for="check-pedido-farmacia">Pedido da Farm√°cia</label>
                        </div>
                        <!-- item condicional ser√° inserido via JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- CHECKLIST PACIENTES -->
        <div id="checklist-pacientes" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div style="font-weight:800">Checklist por Paciente</div>
                </div>
                <div id="checklist-pacientes-container" style="margin-top:12px"></div>
            </div>
        </div>
    </div>

    <!-- MODAIS -->

    <!-- Modal Paciente -->
    <div id="paciente-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <div style="font-weight:800" id="modal-title">Adicionar Paciente</div>
                <div><button class="btn btn-ghost close-modal" data-modal="paciente-modal">Fechar ‚úï</button></div>
            </div>

            <form id="paciente-form">
                <input type="hidden" id="leito-id">
                <div class="modal-grid">
                    <div>
                        <div class="form-group">
                            <label for="nome-paciente">Nome do Paciente</label>
                            <input type="text" id="nome-paciente" required />
                        </div>
                        <div class="form-group">
                            <label for="diagnostico">Diagn√≥stico</label>
                            <input type="text" id="diagnostico" required />
                        </div>
                        <div class="form-group">
                            <label for="data-admissao">Data de Admiss√£o</label>
                            <input type="date" id="data-admissao" />
                        </div>
                        <div class="form-group">
                            <label class="small"><input type="checkbox" id="tem-lesoes"> Possui les√µes?</label>
                            <input type="text" id="especificacao-lesoes" placeholder="Especifique as les√µes (opcional)" style="display:none;margin-top:8px"/>
                        </div>
                    </div>

                    <div>
                        <div style="font-weight:700;margin-bottom:8px">Dispositivos do Paciente (selecionar/editar)</div>
                        <div id="device-inputs-container" class="device-list"></div>
                        <div style="margin-top:8px;display:flex;gap:8px">
                            <input type="text" id="novo-dispositivo-nome-leito" placeholder="Nome do dispositivo (ex: PIG)" />
                            <input type="date" id="novo-dispositivo-data-leito" style="width:160px" />
                            <button class="btn btn-success" id="btn-adicionar-dispositivo-leito" type="button">Adicionar</button>
                        </div>
                    </div>
                </div>

                <div style="margin-top:12px;display:flex;gap:8px">
                    <button class="btn btn-primary" type="submit" style="flex:1">Salvar</button>
                    <button class="btn btn-secondary close-modal" data-modal="paciente-modal" type="button">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Gerenciar Dispositivo por Leito -->
    <div id="dispositivo-modal" class="modal" aria-hidden="true">
        <div class="modal-content" style="max-width:560px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <div style="font-weight:800" id="dispositivo-modal-title">Gerenciar Dispositivos</div>
                <div><button class="btn btn-ghost close-modal" data-modal="dispositivo-modal">Fechar ‚úï</button></div>
            </div>

            <div id="dispositivo-modal-content"></div>

            <div style="margin-top:12px;display:flex;gap:8px">
                <button class="btn btn-primary" id="salvar-alteracoes-dispositivos">Salvar Altera√ß√µes</button>
                <button class="btn btn-secondary close-modal" data-modal="dispositivo-modal">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Visualizar Paciente -->
    <div id="visualizar-paciente-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <div style="font-weight:800" id="visualizar-paciente-modal-title">Visualizar Paciente</div>
                <div><button class="btn btn-ghost close-modal" data-modal="visualizar-paciente-modal">Fechar ‚úï</button></div>
            </div>

            <div id="paciente-detalhes"></div>

            <div style="margin-top:10px">
                <h4>Coment√°rios</h4>
                <div class="comment-list" id="comment-list" style="max-height:200px;overflow:auto;border-radius:8px;border:1px solid #eef5f7;padding:8px;background:#fbfdff"></div>
                <textarea id="novo-comentario" rows="3" style="width:100%;margin-top:8px;padding:8px;border-radius:8px;border:1px solid #e6eef1"></textarea>
                <button class="btn btn-primary" id="adicionar-comentario-btn" style="margin-top:8px;width:100%">Adicionar Coment√°rio</button>
            </div>

            <div style="margin-top:12px"><button class="btn btn-secondary close-modal" data-modal="visualizar-paciente-modal">Fechar</button></div>
        </div>
    </div>

    <!-- Modal Gerenciar Dispositivos Globais -->
    <div id="gerenciar-dispositivos-globais-modal" class="modal" aria-hidden="true">
        <div class="modal-content" style="max-width:600px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <div style="font-weight:800">Gerenciar Dispositivos Globais</div>
                <div><button class="btn btn-ghost close-modal" data-modal="gerenciar-dispositivos-globais-modal">Fechar ‚úï</button></div>
            </div>

            <form id="add-dispositivo-form">
                <div style="display:flex;gap:8px">
                    <input type="text" id="novo-dispositivo-nome" placeholder="Nome do dispositivo (ex: PIG, SC)" />
                    <button class="btn btn-success" type="submit">Adicionar</button>
                </div>
            </form>

            <hr>

            <div>
                <h4>Dispositivos Personalizados</h4>
                <ul class="custom-device-list" id="custom-device-list"></ul>
            </div>

            <div style="margin-top:10px" class="small">Dispositivos fixos: <strong>(TOT, TQT, SNE, SVD, CVP, CVC, VMI, CHD)</strong> n√£o podem ser removidos.</div>
        </div>
    </div>

    <footer>
        <div class="container">Sistema de Gerenciamento de Plant√£o em UTI &copy; 2025</div>
    </footer>

    <script>
    // -----------------------------
    // Dados iniciais / Config
    // -----------------------------
    const DISPOSITIVOS_FIXOS = ['TOT','TQT','SNE','SVD','CVP','CVC','VMI','CHD'];
    const DISPOSITIVOS_COM_DATA = ['CVC','CVP','CHD','SVD'];
    const DISPOSITIVOS_COM_LIMPEZA = ['CVC','CVP','CHD'];
    let DISPOSITIVOS_CUSTOM = []; // carregado do localStorage

    // Exemplo leitos inicial (sem pacientes)
    let leitos = [
        {id:1,paciente:null,tipo:'normal'},
        {id:2,paciente:null,tipo:'normal'},
        {id:3,paciente:null,tipo:'normal'},
        {id:4,paciente:null,tipo:'normal'},
        {id:5,paciente:null,tipo:'normal'},
        {id:6,paciente:null,tipo:'normal'},
        {id:7,paciente:null,tipo:'normal'},
        {id:8,paciente:null,tipo:'normal'},
        {id:9,paciente:null,tipo:'normal'},
        {id:10,paciente:null,tipo:'isolamento'}
    ];

    // checklist di√°rio
    let checklistDiario = {
        carrinho1:false,
        carrinho2:false,
        geladeira8h:false,
        geladeira18h:false,
        livroOcorrencias:false,
        psicotropicos:false,
        pedidoFarmacia:false,
        pedidoFarmaciaDiaSeguinte:false // usado para salvar estado quando checkbox existir
    };

    // ---------- utilidades data ----------
    function hojeISO(){
        return new Date().toISOString().substring(0,10);
    }
    function formatarData(data, includeTime=false){
        if(!data) return 'N/A';
        try{
            // data pode ser YYYY-MM-DD ou ISO
            let d;
            if(typeof data === 'string' && data.length===10 && data.indexOf('T')===-1) {
                const parts=data.split('-'); d=new Date(parseInt(parts[0]),parseInt(parts[1])-1,parseInt(parts[2]));
            } else {
                d=new Date(data);
            }
            if(isNaN(d)) return 'Data Inv√°lida';
            const opts = {day:'2-digit',month:'2-digit',year:'numeric'};
            if(includeTime){ opts.hour='2-digit'; opts.minute='2-digit'; opts.hour12=false; }
            return d.toLocaleString('pt-BR',opts);
        } catch(e){ return data; }
    }
    function calcularDiferencaDias(data){
        if(!data) return null;
        const d = new Date(data+'T00:00:00');
        const hoje = new Date(new Date().toDateString());
        d.setHours(0,0,0,0); hoje.setHours(0,0,0,0);
        return Math.floor((hoje - d)/(1000*60*60*24));
    }
    function calcularDiferencaHoras(data){
        if(!data) return null;
        const d = new Date(data);
        const agora = new Date();
        return Math.floor((agora - d)/(1000*60*60));
    }

    function getStatusDispositivo(dispositivo, data){
        if(!data) return {status:'Dentro do prazo',badge:'badge-success',diferenca:'N/A', level:'ok'};
        let diferenca, limite;
        if(dispositivo === 'CVC' || dispositivo === 'CHD' || dispositivo === 'SVD'){
            diferenca = calcularDiferencaDias(data);
            limite = 7;
            if(diferenca >= limite) return {status:'Vencido',badge:'badge-danger',diferenca: `${diferenca} dias`, level:'danger'};
            if(diferenca >= limite - 2) return {status:'Pr√≥ximo do vencimento',badge:'badge-warning',diferenca: `${diferenca} dias`, level:'warning'};
            return {status:'Dentro do prazo',badge:'badge-success',diferenca: `${diferenca} dias`, level:'ok'};
        } else if(dispositivo === 'CVP'){
            diferenca = calcularDiferencaHoras(data);
            limite = 72;
            if(diferenca >= limite) return {status:'Vencido',badge:'badge-danger',diferenca: `${diferenca}h`, level:'danger'};
            if(diferenca >= limite - 12) return {status:'Pr√≥ximo do vencimento',badge:'badge-warning',diferenca: `${diferenca}h`, level:'warning'};
            return {status:'Dentro do prazo',badge:'badge-success',diferenca: `${diferenca}h`, level:'ok'};
        } else {
            return {status:'N/A',badge:'badge-success',diferenca:'N/A', level:'ok'};
        }
    }

    function getDispositivosPadrao(){
        return [...new Set([...DISPOSITIVOS_FIXOS, ...DISPOSITIVOS_CUSTOM])];
    }

    // -----------------------------
    // LocalStorage: carregar / salvar
    // -----------------------------
    function salvarDados(){
        localStorage.setItem('leitosUTI', JSON.stringify(leitos));
        localStorage.setItem('checklistDiarioUTI', JSON.stringify(checklistDiario));
        localStorage.setItem('dispositivosCustomUTI', JSON.stringify(DISPOSITIVOS_CUSTOM));
    }

    function carregarDados(){
        const savedLeitos = localStorage.getItem('leitosUTI');
        const savedChecklist = localStorage.getItem('checklistDiarioUTI');
        const savedCustom = localStorage.getItem('dispositivosCustomUTI');

        if(savedCustom) {
            try{ DISPOSITIVOS_CUSTOM = JSON.parse(savedCustom); }catch(e){}
        }

        if(savedLeitos){
            try{
                const parsed = JSON.parse(savedLeitos);
                // garantir estrutura
                const todos = getDispositivosPadrao();
                leitos = leitos.map(l => {
                    const sl = parsed.find(x => x.id === l.id);
                    if(sl && sl.paciente){
                        const pacient = sl.paciente;
                        pacient.dispositivos = pacient.dispositivos || {};
                        pacient.comentarios = pacient.comentarios || [];
                        pacient.checklist = pacient.checklist || {};
                        // garantir todos dispositivos
                        getDispositivosPadrao().forEach(dev => {
                            if(!pacient.dispositivos[dev]) pacient.dispositivos[dev] = {presente:false,dataInsercao:null,limpezas:[]};
                            else pacient.dispositivos[dev].limpezas = pacient.dispositivos[dev].limpezas || [];
                        });
                        // garantir dataAdmissao
                        pacient.dataAdmissao = pacient.dataAdmissao || null;
                        // Migra√ß√£o: converter campos antigos de les√£o
                        if (pacient.temLesao !== undefined && pacient.temLesoes === undefined) {
                            pacient.temLesoes = pacient.temLesao;
                            delete pacient.temLesao;
                        }
                        if (pacient.especificacaoLpp !== undefined && pacient.especificacaoLesoes === undefined) {
                            pacient.especificacaoLesoes = pacient.especificacaoLpp;
                            delete pacient.especificacaoLpp;
                        }
                        return { ...l, paciente:pacient };
                    }
                    return l;
                });
            }catch(e){ console.error(e); }
        }

        if(savedChecklist){
            try{
                checklistDiario = JSON.parse(savedChecklist);
                checklistDiario.pedidoFarmaciaDiaSeguinte = checklistDiario.pedidoFarmaciaDiaSeguinte || false;
            }catch(e){}
        }
    }

    // -----------------------------
    // Render principais
    // -----------------------------
    function atualizarDataCabecalho(){
        const now = new Date();
        const options = { weekday:'long',year:'numeric',month:'long',day:'numeric' };
        document.getElementById('current-date').textContent = now.toLocaleDateString('pt-BR',options);
    }

    function renderizarLeitos(){
        const grid = document.getElementById('leitos-grid');
        grid.innerHTML = '';
        const dispositivosComData = DISPOSITIVOS_COM_DATA;
        leitos.forEach(leito => {
            const card = document.createElement('div');
            card.className = 'leito-card';

            let html = `<div class="leito-num">Leito ${leito.id} ${leito.tipo === 'isolamento' ? '<span class="badge badge-iso">Isolamento</span>' : ''}</div>`;

            if(leito.paciente){
                const p = leito.paciente;
                html += `<div class="leito-paciente">${p.nome}</div>`;
                html += `<div class="leito-dx">${p.diagnostico}</div>`;
                if(p.temLesoes) html += `<div class="small"><strong>Les√µes:</strong> ${p.especificacaoLesoes || ''}</div>`;
                html += `<div style="margin-top:8px">`;
                // mostrar dispositivos com destaque
                dispositivosComData.forEach(dev => {
                    const devData = p.dispositivos[dev];
                    if(devData && devData.presente && devData.dataInsercao){
                        const st = getStatusDispositivo(dev, devData.dataInsercao);
                        if(st.level === 'danger' || st.level === 'warning'){
                            html += `<div class="dispositivo ${st.level === 'danger' ? 'vencido' : 'proximo'}"><span>${dev}: ${formatarData(devData.dataInsercao)}</span><span>${st.diferenca}</span></div>`;
                        }
                    }
                });
                html += `</div>`;

                html += `<div style="margin-top:10px;display:flex;gap:8px;flex-direction:column">`;
                html += `<button class="btn btn-info visualizar-paciente" data-leito="${leito.id}" style="width:100%">Visualizar Paciente</button>`;
                html += `<button class="btn btn-ghost gerenciar-dispositivos" data-leito="${leito.id}" style="width:100%">Gerenciar Dispositivos</button>`;
                html += `<button class="btn btn-danger remover-paciente" data-leito="${leito.id}" style="width:100%">Remover</button>`;
                html += `</div>`;
            } else {
                html += `<div style="text-align:center;padding:18px 0"><div class="small">Leito vago</div><button class="btn btn-primary adicionar-paciente" data-leito="${leito.id}" style="margin-top:10px">Adicionar Paciente</button></div>`;
            }

            card.innerHTML = html;
            grid.appendChild(card);
        });

        // event listeners
        document.querySelectorAll('.adicionar-paciente').forEach(b => b.addEventListener('click', e => {
            abrirModalPaciente(parseInt(e.currentTarget.getAttribute('data-leito')), false);
        }));
        document.querySelectorAll('.visualizar-paciente').forEach(b => b.addEventListener('click', e => {
            abrirModalVisualizarPaciente(parseInt(e.currentTarget.getAttribute('data-leito')));
        }));
        document.querySelectorAll('.gerenciar-dispositivos').forEach(b => b.addEventListener('click', e => {
            abrirModalDispositivo(parseInt(e.currentTarget.getAttribute('data-leito')));
        }));
        document.querySelectorAll('.remover-paciente').forEach(b => b.addEventListener('click', e => {
            const id = parseInt(e.currentTarget.getAttribute('data-leito'));
            if(confirm(`Remover paciente do Leito ${id}?`)){
                removerPaciente(id);
            }
        }));

        atualizarTabelaDispositivos(false);
        renderizarQuadroGeralDispositivos();
    }

    // Quadro Geral (com Leito primeira coluna, Paciente segunda, Data Admiss√£o terceira)
    function renderizarQuadroGeralDispositivos(){
        const todos = getDispositivosPadrao();
        const thead = document.getElementById('quadro-geral-header');
        const tbody = document.getElementById('quadro-geral-tbody');

        thead.innerHTML = `<tr><th>Leito</th><th>Paciente</th><th>Data Admiss√£o</th>` + todos.map(d=>`<th style="text-align:center">${d}</th>`).join('') + `</tr>`;

        tbody.innerHTML = '';
        leitos.forEach(l => {
            if(l.paciente){
                const p = l.paciente;
                let row = document.createElement('tr');
                let cols = `<td style="text-align:left">Leito ${l.id}</td>`;
                cols += `<td style="text-align:left;font-weight:700">${p.nome}</td>`;
                cols += `<td style="text-align:left">${p.dataAdmissao ? formatarData(p.dataAdmissao) : '-'}</td>`;

                getDispositivosPadrao().forEach(dev=>{
                    const devData = p.dispositivos[dev];
                    let cell = '-';
                    if(devData && devData.presente){
                        if(devData.dataInsercao){
                            const st = getStatusDispositivo(dev, devData.dataInsercao);
                            // N√£o mostrar "V" ‚Äî apenas data e cor
                            let colorClass = st.level === 'danger' ? 'dot-danger' : (st.level === 'warning' ? 'dot-warning' : 'dot-success');
                            cell = `<div style="display:flex;flex-direction:column;align-items:center">
                                        <div style="display:flex;align-items:center;gap:8px">
                                            <span class="status-dot ${colorClass}"></span>
                                            <span>${formatarData(devData.dataInsercao)}</span>
                                        </div>
                                        <div class="small">${st.level !== 'ok' ? st.diferenca : ''}</div>
                                    </div>`;
                        } else {
                            cell = `<div style="display:flex;align-items:center;justify-content:center">X</div>`;
                        }
                    }
                    cols += `<td>${cell}</td>`;
                });

                row.innerHTML = cols;
                tbody.appendChild(row);
            }
        });
    }

    function dispositivoTemPrazo(dev){
        return DISPOSITIVOS_COM_DATA.includes(dev);
    }

    // Atualizar tabela de dispositivos vencidos/pr√≥ximos
    function atualizarTabelaDispositivos(forReport){
        const tbody = document.getElementById('dispositivos-tbody');
        if(!tbody) return;
        tbody.innerHTML = '';
        const dispositivosComData = DISPOSITIVOS_COM_DATA;
        leitos.forEach(l=>{
            if(l.paciente){
                dispositivosComData.forEach(dev=>{
                    const devData = l.paciente.dispositivos[dev];
                    if(devData && devData.presente && devData.dataInsercao){
                        const st = getStatusDispositivo(dev, devData.dataInsercao);
                        if(st.level === 'danger' || st.level === 'warning'){
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>Leito ${l.id} ${l.tipo==='isolamento' ? '(Isolamento)' : ''}</td>
                                            <td>${l.paciente.nome}</td>
                                            <td>${dev}</td>
                                            <td>${formatarData(devData.dataInsercao)}</td>
                                            <td><span style="padding:6px 8px;border-radius:8px;background:${st.level==='danger'?'#fff1f0':'#fff7ed'};color:${st.level==='danger'?'#b91c1c':'#92400e'}">${st.status} (${st.diferenca})</span></td>`;
                            tbody.appendChild(tr);
                        }
                    }
                });
            }
        });
    }

    // -----------------------------
    // Modal Paciente: abrir / salvar / adicionar dispositivo local
    // -----------------------------
    function abrirModalPaciente(leitoId, editar=false){
        const modal = document.getElementById('paciente-modal');
        const titulo = document.getElementById('modal-title');
        const leitoInput = document.getElementById('leito-id');
        const container = document.getElementById('device-inputs-container');

        leitoInput.value = leitoId;
        container.innerHTML = '';

        const leito = leitos.find(l=>l.id===leitoId);
        const todos = getDispositivosPadrao();

        if(leito.paciente) editar = true;

        if(editar){
            titulo.textContent = `Editar Paciente - Leito ${leitoId}`;
            const p = leito.paciente;
            document.getElementById('nome-paciente').value = p.nome;
            document.getElementById('diagnostico').value = p.diagnostico;
            document.getElementById('tem-lesoes').checked = p.temLesoes || false;
            document.getElementById('especificacao-lesoes').value = p.especificacaoLesoes || '';
            document.getElementById('especificacao-lesoes').style.display = p.temLesoes ? 'block':'none';
            document.getElementById('data-admissao').value = p.dataAdmissao || '';

            // preencher dispositivos
            getDispositivosPadrao().forEach(dev=>{
                const dd = p.dispositivos[dev] || {presente:false,dataInsercao:null,limpezas:[]};
                const dateVal = dd.dataInsercao ? dd.dataInsercao.substring(0,10) : '';
                container.innerHTML += renderDeviceInputHtml(dev, dd.presente, dateVal);
            });
        } else {
            titulo.textContent = `Adicionar Paciente - Leito ${leitoId}`;
            document.getElementById('paciente-form').reset();
            document.getElementById('especificacao-lesoes').style.display = 'none';
            document.getElementById('data-admissao').value = hojeISO();
            document.getElementById('tem-lesoes').checked = false;

            getDispositivosPadrao().forEach(dev=>{
                container.innerHTML += renderDeviceInputHtml(dev,false,'');
            });
        }

        // listeners para checkboxes dentro do modal (toggle input date)
        container.querySelectorAll('input[type="checkbox"]').forEach(ch=>{
            ch.addEventListener('change',function(){
                const dev = this.getAttribute('data-device');
                const dateInput = document.getElementById(`dev-date-${dev}`);
                if(dateInput) dateInput.style.display = this.checked ? 'inline-block' : 'none';
            });
        });

        // bot√£o para adicionar dispositivo espec√≠fico neste leito
        document.getElementById('btn-adicionar-dispositivo-leito').onclick = function(){
            const name = document.getElementById('novo-dispositivo-nome-leito').value.trim();
            const date = document.getElementById('novo-dispositivo-data-leito').value || '';
            if(!name) { alert('Informe o nome do dispositivo'); return; }
            // adicionar ao container e marcar presente
            const devName = name.toUpperCase();
            // se n√£o existir no global, adiciona como custom tempor√°rio (no salvar ser√° persistido)
            if(!DISPOSITIVOS_CUSTOM.includes(devName) && !DISPOSITIVOS_FIXOS.includes(devName)){
                DISPOSITIVOS_CUSTOM.push(devName);
                salvarDados();
                renderizarLeitos(); // atualiza visual para incluir coluna
            }
            container.innerHTML += renderDeviceInputHtml(devName,true,date);
            document.getElementById('novo-dispositivo-nome-leito').value = '';
            document.getElementById('novo-dispositivo-data-leito').value = '';
        };

        abrirModal('paciente-modal');
    }

    function renderDeviceInputHtml(dev, checked, dateVal){
        return `<div class="device-item" id="device-item-${dev}">
                    <div class="left">
                        <label style="display:flex;align-items:center;gap:8px">
                            <input type="checkbox" class="device-checkbox" id="dev-check-${dev}" data-device="${dev}" ${checked ? 'checked':''}>
                            <span style="font-weight:700">${dev}</span>
                        </label>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center">
                        <input type="date" id="dev-date-${dev}" data-device-date="${dev}" value="${dateVal}" style="display:${checked ? 'inline-block':'none'}">
                        <button class="btn btn-ghost" type="button" onclick="removerDeviceItemFromModal('${dev}')">Remover</button>
                    </div>
                </div>`;
    }

    function removerDeviceItemFromModal(dev){
        // remove do DOM dentro do modal sem remover do global autom√°tico
        const el = document.getElementById(`device-item-${dev}`);
        if(el) el.remove();
    }

    // salvar paciente novo/editar
    document.getElementById('paciente-form').addEventListener('submit', salvarPaciente);
    function salvarPaciente(e){
        e.preventDefault();
        const leitoId = parseInt(document.getElementById('leito-id').value);
        const nome = document.getElementById('nome-paciente').value.trim();
        const diagnostico = document.getElementById('diagnostico').value.trim();
        const temLesoes = document.getElementById('tem-lesoes').checked;
        const especificacaoLesoes = document.getElementById('especificacao-lesoes').value.trim();
        const dataAdmissao = document.getElementById('data-admissao').value || hojeISO();

        const leitoIndex = leitos.findIndex(l=>l.id===leitoId);
        const pacienteExistente = leitos[leitoIndex].paciente;

        // recuperar inputs de dispositivos do modal
        const todosInputs = Array.from(document.querySelectorAll('#device-inputs-container .device-item'));
        let dispositivos = pacienteExistente ? JSON.parse(JSON.stringify(pacienteExistente.dispositivos)) : {};
        let checklist = pacienteExistente ? JSON.parse(JSON.stringify(pacienteExistente.checklist)) : {};
        let comentarios = pacienteExistente ? pacienteExistente.comentarios : [];

        // garantir estrutura dos dispositivos atuais
        getDispositivosPadrao().forEach(dev=>{
            if(!dispositivos[dev]) dispositivos[dev] = {presente:false,dataInsercao:null,limpezas:[]};
            dispositivos[dev].limpezas = dispositivos[dev].limpezas || [];
        });

        todosInputs.forEach(item => {
            const cb = item.querySelector('input[type="checkbox"]');
            const dev = cb.getAttribute('data-device');
            const checked = cb.checked;
            const dateInput = item.querySelector('input[type="date"]');
            const dateVal = dateInput ? dateInput.value || null : null;

            // preserva limpezas anteriores
            const limpezas = dispositivos[dev] ? dispositivos[dev].limpezas || [] : [];

            // se desmarcou, zera dataInsercao (conforme solicitado)
            if(dispositivos[dev] && dispositivos[dev].presente && !checked){
                dispositivos[dev].dataInsercao = null;
            }

            // se marcou e h√° data, utiliza essa data; se marcou e n√£o h√° data e dispositivo pede data, usa hoje
            let dataInsercaoFinal = null;
            if(checked){
                if(dateVal && dateVal !== '') dataInsercaoFinal = dateVal;
                else if(dispositivoTemPrazo(dev) && !dispositivos[dev].dataInsercao) dataInsercaoFinal = hojeISO();
                else dataInsercaoFinal = dispositivos[dev].dataInsercao || null;
            } else {
                dataInsercaoFinal = null;
            }

            dispositivos[dev] = {presente:checked, dataInsercao: dataInsercaoFinal, limpezas: limpezas};
        });

        // se for paciente novo, inicializa checklist padrao (adicionando os novos dispositivos)
        if(!pacienteExistente){
            checklist = {};
            getDispositivosPadrao().forEach(dev=>{
                checklist[dev] = { curativo:false, aspiracao:false };
            });
        } else {
            // garantir checklist inclui novos dispositivos se custom adicionados
            getDispositivosPadrao().forEach(dev=>{
                if(!checklist[dev]) checklist[dev] = {curativo:false,aspiracao:false};
            });
        }

        leitos[leitoIndex].paciente = {
            nome,
            diagnostico,
            temLesoes,
            especificacaoLesoes: temLesoes ? especificacaoLesoes : null,
            dispositivos,
            comentarios,
            checklist,
            dataAdmissao
        };

        // salvar custom devices globalmente (se novos foram adicionados no modal)
        // var DISPOSITIVOS_CUSTOM ja atualizado ao adicionar via bot√£o

        salvarDados();
        fecharModal('paciente-modal');
        renderizarLeitos();
    }

    // remover paciente
    function removerPaciente(leitoId){
        const idx = leitos.findIndex(l=>l.id===leitoId);
        leitos[idx].paciente = null;
        salvarDados();
        renderizarLeitos();
    }

    // -----------------------------
    // Modal Visualizar Paciente e coment√°rios
    // -----------------------------
    function abrirModalVisualizarPaciente(leitoId){
        const leito = leitos.find(l=>l.id===leitoId);
        if(!leito || !leito.paciente) return;
        const modalTitle = document.getElementById('visualizar-paciente-modal-title');
        const detalhes = document.getElementById('paciente-detalhes');
        const commentList = document.getElementById('comment-list');
        modalTitle.textContent = `Leito ${leitoId}: ${leito.paciente.nome}`;

        let html = `<p><strong>Diagn√≥stico:</strong> ${leito.paciente.diagnostico}</p>`;
        html += `<p><strong>Data Admiss√£o:</strong> ${leito.paciente.dataAdmissao ? formatarData(leito.paciente.dataAdmissao) : '-'}</p>`;
        html += `<p><strong>Possui les√µes:</strong> ${leito.paciente.temLesoes ? (leito.paciente.especificacaoLesoes || 'Sim') : 'N√£o'}</p>`;
        html += `<h4 style="margin-top:10px">Dispositivos Presentes</h4><ul>`;
        getDispositivosPadrao().forEach(dev=>{
            const dd = leito.paciente.dispositivos[dev];
            if(dd && dd.presente){
                let statusInfo = '';
                if(dd.dataInsercao){
                    statusInfo = ` - Inser√ß√£o: ${formatarData(dd.dataInsercao)}`;
                    if(dispositivoTemPrazo(dev)){
                        const st = getStatusDispositivo(dev, dd.dataInsercao);
                        statusInfo += ` (${st.diferenca}) - ${st.status}`;
                    }
                    if(dd.limpezas && dd.limpezas.length > 0){
                        const ult = dd.limpezas[dd.limpezas.length-1];
                        statusInfo += `<br>√öltima limpeza: ${formatarData(ult,true)}`;
                    }
                }
                html += `<li><strong>${dev}</strong>${statusInfo}</li>`;
            }
        });
        html += `</ul>`;
        detalhes.innerHTML = html;

        // comentarios
        commentList.innerHTML = '';
        if(leito.paciente.comentarios.length === 0){
            commentList.innerHTML = '<div class="small" style="text-align:center;color:var(--muted)">Nenhum coment√°rio.</div>';
        } else {
            leito.paciente.comentarios.slice().reverse().forEach(c=>{
                const div = document.createElement('div');
                div.style.padding='8px'; div.style.marginBottom='8px'; div.style.borderLeft='3px solid rgba(14,165,183,0.12)';
                div.innerHTML = `${c.texto}<div class="small" style="margin-top:6px;color:var(--muted)">Adicionado em: ${formatarData(c.data,true)}</div>`;
                commentList.appendChild(div);
            });
        }

        // configurar adicionar coment√°rio
        document.getElementById('adicionar-comentario-btn').onclick = () => adicionarComentario(leitoId);

        abrirModal('visualizar-paciente-modal');
    }

    function adicionarComentario(leitoId){
        const val = document.getElementById('novo-comentario').value.trim();
        if(!val){ alert('Digite um coment√°rio'); return; }
        const idx = leitos.findIndex(l=>l.id===leitoId);
        leitos[idx].paciente.comentarios.push({texto:val, data:new Date().toISOString()});
        salvarDados();
        document.getElementById('novo-comentario').value='';
        abrirModalVisualizarPaciente(leitoId);
    }

    // -----------------------------
    // Modal Gerenciar Dispositivo por Leito (edi√ß√£o, adicionar, remover, registrar limpeza)
    // -----------------------------
    function abrirModalDispositivo(leitoId){
        const leito = leitos.find(l=>l.id===leitoId);
        if(!leito || !leito.paciente) return;
        const modal = document.getElementById('dispositivo-modal');
        const title = document.getElementById('dispositivo-modal-title');
        const content = document.getElementById('dispositivo-modal-content');
        title.textContent = `Gerenciar Dispositivos - Leito ${leitoId}: ${leito.paciente.nome}`;
        content.innerHTML = '';

        // listagem: cada dispositivo atual com presente=true ou que tenha data/limpezas ‚Äî permitir editar data, limpar, remover
        const todos = getDispositivosPadrao();
        let html = '';
        html += `<div style="margin-bottom:8px"><strong>Dispositivos do paciente</strong></div>`;
        html += `<div class="device-list">`;
        todos.forEach(dev=>{
            const dd = leito.paciente.dispositivos[dev] || {presente:false,dataInsercao:null,limpezas:[]};
            const dateVal = dd.dataInsercao ? dd.dataInsercao.substring(0,10) : '';
            // se dispositivo n√£o existir e n√£o presente e sem hist√≥rico, pode n√£o ser mostrado ‚Äî por√©m mostramos para permitir adicionar
            html += `<div class="device-item" id="ger-dev-${dev}">
                        <div class="left">
                            <label style="display:flex;align-items:center;gap:8px">
                                <input type="checkbox" class="ger-dev-check" data-device="${dev}" ${dd.presente ? 'checked':''}><strong>${dev}</strong>
                            </label>
                        </div>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input type="date" class="ger-dev-date" data-device-date="${dev}" value="${dateVal}" style="${dd.presente ? 'display:inline-block':''}">
                            <button class="btn btn-success registrar-limpeza" data-device="${dev}">Registrar Limpeza</button>
                            <button class="btn btn-ghost remover-ger-dev" data-device="${dev}">Remover</button>
                        </div>
                    </div>`;
        });
        html += `</div>`;

        // adicionar novo dispositivo espec√≠fico ao leito
        html += `<div style="margin-top:10px;display:flex;gap:8px">
                    <input type="text" id="novo-dev-leito-nome" placeholder="Novo dispositivo (ex: PIG)">
                    <input type="date" id="novo-dev-leito-data" style="width:160px">
                    <button class="btn btn-primary" id="novo-dev-leito-btn">Adicionar</button>
                 </div>`;

        content.innerHTML = html;

        // eventos
        content.querySelectorAll('.ger-dev-check').forEach(ch=>{
            ch.addEventListener('change', function(){
                const dev = this.getAttribute('data-device');
                const dateInput = content.querySelector(`.ger-dev-date[data-device-date="${dev}"]`);
                if(dateInput) dateInput.style.display = this.checked ? 'inline-block' : 'none';
            });
        });

        content.querySelectorAll('.registrar-limpeza').forEach(btn=>{
            btn.addEventListener('click', function(){
                const dev = this.getAttribute('data-device');
                // registrar limpeza ‚Äî adicionar timestamp e resetar dataInsercao para hoje (solicitado)
                registrarLimpeza(leitoId, dev, true);
                abrirModalDispositivo(leitoId); // recarrega
            });
        });

        content.querySelectorAll('.remover-ger-dev').forEach(btn=>{
            btn.addEventListener('click', function(){
                const dev = this.getAttribute('data-device');
                if(confirm(`Remover dispositivo ${dev} deste paciente? (ficar√° desmarcado)`)){
                    // desmarcar presen√ßa e limpar dataInsercao
                    leito.paciente.dispositivos[dev] = {presente:false,dataInsercao:null,limpezas: leito.paciente.dispositivos[dev] ? leito.paciente.dispositivos[dev].limpezas : []};
                    salvarDados();
                    abrirModalDispositivo(leitoId);
                }
            });
        });

        // adicionar novo dispositivo do leito
        content.querySelector('#novo-dev-leito-btn').addEventListener('click', function(){
            const name = document.getElementById('novo-dev-leito-nome').value.trim();
            const date = document.getElementById('novo-dev-leito-data').value || '';
            if(!name){ alert('Informe nome'); return; }
            const devName = name.toUpperCase();
            // adicionar ao global customize se necess√°rio
            if(!DISPOSITIVOS_CUSTOM.includes(devName) && !DISPOSITIVOS_FIXOS.includes(devName)){
                DISPOSITIVOS_CUSTOM.push(devName);
            }
            // adicionar ao paciente
            leito.paciente.dispositivos[devName] = {presente:true, dataInsercao: date || (dispositivoTemPrazo(devName) ? hojeISO() : null), limpezas: []};
            salvarDados();
            abrirModalDispositivo(leitoId);
        });

        // salvar altera√ß√µes (pegar checks e dates)
        document.getElementById('salvar-alteracoes-dispositivos').onclick = function(){
            const checks = Array.from(content.querySelectorAll('.ger-dev-check'));
            checks.forEach(ch=>{
                const dev = ch.getAttribute('data-device');
                const checked = ch.checked;
                const dateInput = content.querySelector(`.ger-dev-date[data-device-date="${dev}"]`);
                const dateVal = dateInput ? dateInput.value || null : null;
                const prev = leito.paciente.dispositivos[dev] || {presente:false,dataInsercao:null,limpezas:[]};
                // se marcar e houver dateVal, atualiza; se marcar e n√£o houver dateVal e for prazo, se prev date null -> hoje
                let finalDate = null;
                if(checked){
                    if(dateVal && dateVal !== '') finalDate = dateVal;
                    else if(dispositivoTemPrazo(dev) && !prev.dataInsercao) finalDate = hojeISO();
                    else finalDate = prev.dataInsercao || null;
                } else {
                    finalDate = null;
                }
                leito.paciente.dispositivos[dev] = {presente:checked, dataInsercao: finalDate, limpezas: prev.limpezas || []};
            });
            // persistir novos dispositivos custom se houver
            salvarDados();
            fecharModal('dispositivo-modal');
            renderizarLeitos();
        };

        abrirModal('dispositivo-modal');
    }

    // registrarLimpeza: adicionar timestamp em limpezas e resetar dataInsercao para hoje
    function registrarLimpeza(leitoId, device, alterarDataInsercaoParaHoje=true){
        const li = leitos.findIndex(l=>l.id===leitoId);
        if(li < 0) return;
        const paciente = leitos[li].paciente;
        if(!paciente) return;
        if(!paciente.dispositivos[device]) paciente.dispositivos[device] = {presente:true,dataInsercao:null,limpezas:[]};
        const nowIso = new Date().toISOString();
        paciente.dispositivos[device].limpezas = paciente.dispositivos[device].limpezas || [];
        paciente.dispositivos[device].limpezas.push(nowIso);
        // atualizar data de inser√ß√£o para o dia atual (solicitado)
        if(alterarDataInsercaoParaHoje){
            // Se o dispositivo requer data de insercao, setar para hoje
            if(dispositivoTemPrazo(device)){
                paciente.dispositivos[device].dataInsercao = hojeISO();
            } else {
                // para dispositivos sem prazo, n√£o √© necess√°rio alterar dataInsercao (mas pode ser nulo)
                paciente.dispositivos[device].dataInsercao = paciente.dispositivos[device].dataInsercao || null;
            }
        }
        salvarDados();
        alert(`Limpeza/Curativo de ${device} registrada com sucesso.`);
        renderizarLeitos();
    }

    // -----------------------------
    // Checklist Di√°rio condicional (ter√ßa e quinta)
    // -----------------------------
    function renderizarChecklistDiarioCondicional(){
        const farmaciaSection = document.getElementById('farmacia-checklist-section');
        if(!farmaciaSection) return;
        const today = new Date().getDay(); // 0 Domingo .. 6 S√°bado
        const isTueOrThu = today === 2 || today === 4; // 2 ter√ßa, 4 quinta
        const existing = document.getElementById('pedido-farmacia-dia-seguinte-item');
        if(isTueOrThu){
            if(!existing){
                const novo = document.createElement('div');
                novo.className = 'checklist-item';
                novo.id = 'pedido-farmacia-dia-seguinte-item';
                novo.innerHTML = `<input type="checkbox" id="check-pedido-farmacia-dia-seguinte"><label for="check-pedido-farmacia-dia-seguinte">Pedido da Farm√°cia do dia seguinte</label>`;
                const staticItem = document.getElementById('pedido-farmacia-item');
                staticItem.parentNode.insertBefore(novo, staticItem.nextSibling);
            }
        } else {
            if(existing) existing.remove();
        }
    }

    function atualizarChecklistDiarioVisual(){
        document.getElementById('check-carrinho1').checked = checklistDiario.carrinho1;
        document.getElementById('check-carrinho2').checked = checklistDiario.carrinho2;
        document.getElementById('check-geladeira-8h').checked = checklistDiario.geladeira8h;
        document.getElementById('check-geladeira-18h').checked = checklistDiario.geladeira18h;
        document.getElementById('check-livro-ocorrencias').checked = checklistDiario.livroOcorrencias;
        document.getElementById('check-psicotropicos').checked = checklistDiario.psicotropicos;
        document.getElementById('check-pedido-farmacia').checked = checklistDiario.pedidoFarmacia;
        const cond = document.getElementById('check-pedido-farmacia-dia-seguinte');
        if(cond) cond.checked = checklistDiario.pedidoFarmaciaDiaSeguinte;
        // style toggles
        document.querySelectorAll('.checklist-item').forEach(item=>{
            const cb = item.querySelector('input[type="checkbox"]');
            if(cb) item.classList.toggle('checked', cb.checked);
        });
    }

    document.getElementById('salvar-checklist-diario').addEventListener('click', function(){
        checklistDiario.carrinho1 = document.getElementById('check-carrinho1').checked;
        checklistDiario.carrinho2 = document.getElementById('check-carrinho2').checked;
        checklistDiario.geladeira8h = document.getElementById('check-geladeira-8h').checked;
        checklistDiario.geladeira18h = document.getElementById('check-geladeira-18h').checked;
        checklistDiario.livroOcorrencias = document.getElementById('check-livro-ocorrencias').checked;
        checklistDiario.psicotropicos = document.getElementById('check-psicotropicos').checked;
        checklistDiario.pedidoFarmacia = document.getElementById('check-pedido-farmacia').checked;
        const cond = document.getElementById('check-pedido-farmacia-dia-seguinte');
        if(cond) checklistDiario.pedidoFarmaciaDiaSeguinte = cond.checked;
        salvarDados();
        atualizarChecklistDiarioVisual();
        alert('Checklist Di√°rio salvo!');
    });

    // -----------------------------
    // Checklist por paciente (incluir Paciente identificado, Higieniza√ß√£o, Curativos se temLesao)
    // -----------------------------
    function renderizarChecklistPorPaciente(){
        const container = document.getElementById('checklist-pacientes-container');
        container.innerHTML = '';
        leitos.forEach(leito=>{
            if(leito.paciente){
                const p = leito.paciente;
                let html = `<div class="card" style="margin-bottom:12px">
                                <div class="card-header"><div style="font-weight:800">Leito ${leito.id}: ${p.nome}</div></div>
                                <div style="padding:12px">
                                    <div class="checklist-item"><input type="checkbox" id="check-id-${leito.id}" ${p.checkPaciente && p.checkPaciente.identificado ? 'checked':''}><label for="check-id-${leito.id}">Paciente identificado</label></div>
                                    <div class="checklist-item"><input type="checkbox" id="check-hig-${leito.id}" ${p.checkPaciente && p.checkPaciente.higienizacao ? 'checked':''}><label for="check-hig-${leito.id}">Higieniza√ß√£o</label></div>`;

                // curativos apenas se temLesoes
                if(p.temLesoes){
                    html += `<div class="checklist-item"><input type="checkbox" id="check-cur-${leito.id}" ${p.checkPaciente && p.checkPaciente.realizacaoCurativos ? 'checked':''}><label for="check-cur-${leito.id}">Realiza√ß√£o de curativos</label></div>`;
                }

                // adicionar checklist por dispositivo (curativo/aspira√ß√£o)
                html += `<div style="margin-top:10px">`;
                for(const dev in p.checklist){
                    if(p.dispositivos[dev] && p.dispositivos[dev].presente){
                        html += `<div class="small" style="margin-top:8px;font-weight:700">${dev}</div>
                                 <div class="checklist-item"><input type="checkbox" data-leito="${leito.id}" data-dev="${dev}" data-item="curativo" id="check-p-${leito.id}-${dev}-cur" ${p.checklist[dev].curativo ? 'checked':''}><label for="check-p-${leito.id}-${dev}-cur">Curativo</label></div>
                                 <div class="checklist-item"><input type="checkbox" data-leito="${leito.id}" data-dev="${dev}" data-item="aspiracao" id="check-p-${leito.id}-${dev}-asp" ${p.checklist[dev].aspiracao ? 'checked':''}><label for="check-p-${leito.id}-${dev}-asp">Aspirar</label></div>`;
                    }
                }
                html += `</div><div style="margin-top:12px"><button class="btn btn-primary salvar-checklist-paciente" data-leito="${leito.id}" style="width:100%">Salvar Checklist</button></div></div></div>`;
                container.innerHTML += html;
            }
        });

        // listeners salvar
        document.querySelectorAll('.salvar-checklist-paciente').forEach(b=>{
            b.addEventListener('click', function(){
                const id = parseInt(this.getAttribute('data-leito'));
                salvarChecklistPaciente(id);
            });
        });

        // toggle checked classes visually
        document.querySelectorAll('#checklist-pacientes-container input[type="checkbox"]').forEach(cb=>{
            cb.addEventListener('change', function(){
                this.closest('.checklist-item')?.classList.toggle('checked', this.checked);
            });
        });
    }

    function salvarChecklistPaciente(leitoId){
        const leitoIdx = leitos.findIndex(l=>l.id===leitoId);
        const p = leitos[leitoIdx].paciente;
        // checklist paciente geral
        p.checkPaciente = {
            identificado: document.getElementById(`check-id-${leitoId}`)?.checked || false,
            higienizacao: document.getElementById(`check-hig-${leitoId}`)?.checked || false,
            realizacaoCurativos: p.temLesoes ? (document.getElementById(`check-cur-${leitoId}`)?.checked || false) : false
        };
        // checklist por dispositivo
        const inputs = document.querySelectorAll(`#checklist-pacientes-container input[data-leito="${leitoId}"]`);
        inputs.forEach(inp=>{
            const dev = inp.getAttribute('data-dev');
            const item = inp.getAttribute('data-item');
            if(p.checklist[dev]) p.checklist[dev][item] = inp.checked;
        });
        salvarDados();
        alert(`Checklist do Leito ${leitoId} salvo!`);
        renderizarChecklistPorPaciente();
    }

    // -----------------------------
    // Gerenciar dispositivos globais (adicionar/remover custom)
    // -----------------------------
    document.getElementById('add-dispositivo-form').addEventListener('submit', function(e){
        e.preventDefault();
        const nome = document.getElementById('novo-dispositivo-nome').value.trim();
        if(!nome) return alert('Informe nome do dispositivo');
        const n = nome.toUpperCase();
        if(!DISPOSITIVOS_CUSTOM.includes(n) && !DISPOSITIVOS_FIXOS.includes(n)){
            DISPOSITIVOS_CUSTOM.push(n);
            salvarDados();
            preencherListaCustomDevices();
            renderizarLeitos();
            document.getElementById('novo-dispositivo-nome').value='';
        } else alert('J√° existe esse dispositivo.');
    });

    function preencherListaCustomDevices(){
        const ul = document.getElementById('custom-device-list');
        ul.innerHTML = '';
        DISPOSITIVOS_CUSTOM.forEach(dev=>{
            ul.innerHTML += `<li style="display:flex;justify-content:space-between;align-items:center;padding:8px;background:#fbfdff;border-radius:8px;margin-bottom:6px">
                                <div style="font-weight:700">${dev}</div>
                                <div style="display:flex;gap:8px">
                                    <button class="btn btn-ghost" data-remove-dev="${dev}">Remover</button>
                                </div>
                             </li>`;
        });
        // listeners
        document.querySelectorAll('[data-remove-dev]').forEach(b=>{
            b.addEventListener('click', function(){
                const dev = this.getAttribute('data-remove-dev');
                if(confirm(`Remover ${dev} dos dispositivos personalizados? (n√£o afetar√° dispositivos j√° salvos em pacientes)`)){
                    DISPOSITIVOS_CUSTOM = DISPOSITIVOS_CUSTOM.filter(x=>x!==dev);
                    salvarDados();
                    preencherListaCustomDevices();
                    renderizarLeitos();
                }
            });
        });
    }

    // -----------------------------
    // Modal helpers
    // -----------------------------
    function abrirModal(id){
        document.getElementById(id).classList.add('open');
    }
    function fecharModal(id){
        document.getElementById(id).classList.remove('open');
    }
    // fechar ao clicar em bot√µes
    document.querySelectorAll('.close-modal').forEach(b=>{
        b.addEventListener('click', function(){
            const id = this.getAttribute('data-modal');
            fecharModal(id);
        });
    });

    // -----------------------------
    // Inicializa√ß√£o / eventos UI
    // -----------------------------
    function initUI(){
        // tabs
        document.querySelectorAll('.nav-tabs .tab').forEach(t=>{
            t.addEventListener('click', function(){
                document.querySelectorAll('.nav-tabs .tab').forEach(x=>x.classList.remove('active'));
                this.classList.add('active');
                const tab = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(tc=>tc.classList.remove('active'));
                document.getElementById(tab).classList.add('active');
                // por seguran√ßa rerenderizar
                if(tab === 'leitos') renderizarLeitos();
                if(tab === 'checklist-pacientes') renderizarChecklistPorPaciente();
            });
        });

        // bot√µes gerenciar global
        document.getElementById('gerenciar-dispositivos-globais-btn').addEventListener('click', ()=>{
            preencherListaCustomDevices();
            abrirModal('gerenciar-dispositivos-globais-modal');
        });

        document.getElementById('adicionar-paciente-btn').addEventListener('click', ()=> abrirModalPaciente(1,false) );

        // salvar checkbox di√°rio inicial
        document.getElementById('salvar-checklist-diario').addEventListener('click', ()=>{ /* j√° ligado acima */ });

        // quando abrir modal paciente, esconder/exibir campo les√µes
        document.getElementById('tem-lesoes').addEventListener('change', function(){
            document.getElementById('especificacao-lesoes').style.display = this.checked ? 'block' : 'none';
        });

        // evento para gerar relat√≥rio (simples)
        document.getElementById('gerar-relatorio-btn').addEventListener('click', ()=>{
            const html = getRelatorioHtml(leitos, checklistDiario);
            const w = window.open('','Relat√≥rio','width=900,height=700');
            w.document.write(html); w.document.close();
        });

        // delega√ß√£o para abrir paciente modal ao clicar em bot√£o adicionar de cada cartao vago
        // (isso √© feito ao renderizar leitos)

    }

    // Relat√≥rio (incluindo Quadro Geral)
    function getRelatorioHtml(leitosData, checklist){
        const dataAtual = new Date().toLocaleString('pt-BR',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});
        
        // Quadro Geral de Dispositivos
        const todos = getDispositivosPadrao();
        let quadroGeralHtml = '<h3>Quadro Geral de Dispositivos (Todos os Pacientes)</h3>';
        quadroGeralHtml += '<table style="width:100%;border-collapse:collapse;margin-bottom:20px"><thead><tr><th style="border:1px solid #ddd;padding:8px">Leito</th><th style="border:1px solid #ddd;padding:8px">Paciente</th><th style="border:1px solid #ddd;padding:8px">Data Admiss√£o</th>';
        
        todos.forEach(d => {
            quadroGeralHtml += `<th style="border:1px solid #ddd;padding:8px;text-align:center">${d}</th>`;
        });
        
        quadroGeralHtml += '</tr></thead><tbody>';
        
        leitosData.forEach(l => {
            if(l.paciente){
                const p = l.paciente;
                quadroGeralHtml += `<tr><td style="border:1px solid #ddd;padding:8px">Leito ${l.id}</td>`;
                quadroGeralHtml += `<td style="border:1px solid #ddd;padding:8px">${p.nome}</td>`;
                quadroGeralHtml += `<td style="border:1px solid #ddd;padding:8px">${p.dataAdmissao ? formatarData(p.dataAdmissao) : '-'}</td>`;
                
                todos.forEach(dev=>{
                    const devData = p.dispositivos[dev];
                    let cell = '-';
                    if(devData && devData.presente){
                        if(devData.dataInsercao){
                            const st = getStatusDispositivo(dev, devData.dataInsercao);
                            let color = st.level === 'danger' ? 'red' : (st.level === 'warning' ? 'orange' : 'green');
                            cell = `<div style="display:flex;flex-direction:column;align-items:center">
                                        <div style="display:flex;align-items:center;gap:8px">
                                            <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color}"></span>
                                            <span>${formatarData(devData.dataInsercao)}</span>
                                        </div>
                                        <div style="font-size:0.8rem">${st.level !== 'ok' ? st.diferenca : ''}</div>
                                    </div>`;
                        } else {
                            cell = `<div style="display:flex;align-items:center;justify-content:center">X</div>`;
                        }
                    }
                    quadroGeralHtml += `<td style="border:1px solid #ddd;padding:8px">${cell}</td>`;
                });
                
                quadroGeralHtml += '</tr>';
            }
        });
        
        quadroGeralHtml += '</tbody></table>';

        // Dispositivos com prazo
        const dispositivosComData = DISPOSITIVOS_COM_DATA;
        let dispositivosHtml = '';
        let hasDevices = false;
        leitosData.forEach(l=>{
            if(l.paciente){
                dispositivosComData.forEach(dev=>{
                    const dd = l.paciente.dispositivos[dev];
                    if(dd && dd.presente && dd.dataInsercao){
                        hasDevices = true;
                        const st = getStatusDispositivo(dev, dd.dataInsercao);
                        dispositivosHtml += `<tr><td style="border:1px solid #ddd;padding:8px">${l.id}</td><td style="border:1px solid #ddd;padding:8px">${l.paciente.nome}</td><td style="border:1px solid #ddd;padding:8px">${dev}</td><td style="border:1px solid #ddd;padding:8px">${formatarData(dd.dataInsercao)}</td><td style="border:1px solid #ddd;padding:8px">${st.status} (${st.diferenca})</td></tr>`;
                    }
                });
            }
        });
        if(!hasDevices) dispositivosHtml = `<tr><td colspan="5" style="text-align:center;border:1px solid #ddd;padding:8px">Nenhum dispositivo de prazo inserido.</td></tr>`;

        // checklist di√°rio
        const nomeChecklist = {
            carrinho1:'Check Carrinho 1',
            carrinho2:'Check Carrinho 2',
            geladeira8h:'Checar Geladeira (8h)',
            geladeira18h:'Checar Geladeira (18h)',
            livroOcorrencias:'Abrir Livro de Ocorr√™ncias',
            psicotropicos:'Checar Psicotr√≥picos',
            pedidoFarmacia:'Pedido da Farm√°cia',
            pedidoFarmaciaDiaSeguinte:'Pedido da Farm√°cia do dia seguinte (TER/QUI)'
        };
        let diarioHtml = '<ul>';
        Object.keys(checklist).forEach(k=>{
            if(k==='pedidoFarmaciaDiaSeguinte' && (new Date().getDay() !== 2 && new Date().getDay() !== 4)) return;
            const label = nomeChecklist[k] || k;
            diarioHtml += `<li>${checklist[k] ? '‚úÖ' : '‚ùå'} ${label}</li>`;
        });
        diarioHtml += '</ul>';

        // pacientes checklist
        let pacientesHtml = '';
        leitosData.forEach(l=>{
            if(l.paciente){
                pacientesHtml += `<div style="margin-bottom:8px"><h4>Leito ${l.id}: ${l.paciente.nome} - ${l.paciente.diagnostico}</h4><ul>`;
                const p = l.paciente;
                for(const dev in p.checklist){
                    if(p.dispositivos[dev] && p.dispositivos[dev].presente){
                        pacientesHtml += `<li><strong>${dev}:</strong> Curativo ${p.checklist[dev].curativo ? '‚úÖ':'‚ùå'}, Aspirar ${p.checklist[dev].aspiracao ? '‚úÖ':'‚ùå'}</li>`;
                    }
                }
                pacientesHtml += `</ul></div>`;
            }
        });

        return `<!doctype html><html lang="pt-BR"><head><meta charset="utf-8"><title>Relat√≥rio Round - ${dataAtual}</title><style>body{font-family:Arial,Helvetica,sans-serif;color:#222;margin:20px}</style></head><body>
                <h2>Relat√≥rio Round - ${dataAtual}</h2>
                ${quadroGeralHtml}
                <h3>Dispositivos com prazo</h3>
                <table style="width:100%;border-collapse:collapse"><thead><tr><th style="border:1px solid #ddd;padding:8px">Leito</th><th style="border:1px solid #ddd;padding:8px">Paciente</th><th style="border:1px solid #ddd;padding:8px">Dispositivo</th><th style="border:1px solid #ddd;padding:8px">Data de Inser√ß√£o</th><th style="border:1px solid #ddd;padding:8px">Status</th></tr></thead><tbody>${dispositivosHtml}</tbody></table>
                <h3>Checklist Di√°rio</h3>${diarioHtml}
                <h3>Checklist por Paciente</h3>${pacientesHtml}
                </body></html>`;
    }

    // -----------------------------
    // boot
    // -----------------------------
    carregarDados();
    atualizarDataCabecalho();
    renderizarChecklistDiarioCondicional();
    atualizarChecklistDiarioVisual();
    renderizarLeitos();
    renderizarChecklistPorPaciente();
    preencherListaCustomDevices();
    initUI();

    // salvar ao trocar janela (para garantir)
    window.addEventListener('beforeunload', salvarDados);

    </script>
</body>
</html>
